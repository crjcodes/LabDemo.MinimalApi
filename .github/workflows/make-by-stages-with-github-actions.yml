# Barebones of continuous integration in stages

# Much, much room for optimization and bringing closer to the real world

name: LabDemo.MinimalApi.BuildByStages
run-name: ${{ github.actor }} is experimenting with GitHub actions 🚀
on: [push]

env:
    SOLUTION: LabDemo.MinimalApi
    PROJECT: LabDemo.MinimalApi

jobs:

  #============================================================
  #  BUILD STAGE

  build:
    name: Build the API

    runs-on: ubuntu-latest
    strategy:
      matrix:
        dotnet-version: ['7.x.x' ]

    steps:       
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    # TODO: only for debug
    - name: Setup .NET Core SDK ${{ matrix.dotnet-version }}
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ matrix.dotnet-version }}

    - name: Inputs
      run: |
        echo "SOLUTION = $SOLUTION"
        echo "PROJECT = $PROJECT"
        echo "Running in..."
        pwd
        cd ..
        pwd
        echo "Total solution storage consumption before job:" 
        du -sh ./* | sort -h

    - name: Build the project
      run: |
        pwd
        dotnet build

    - name: Metrics
      run: |
        echo "Total storage consumption after job:" 
        pwd
        du -sh ./* | sort -h
        
  #============================================================
  #  TEST STAGE

  test:
    name: Black-box test the API
    runs-on: ubuntu-latest

    strategy:
      matrix:
        dotnet-version: ['7.x.x' ]

    needs: [build]

    env:
      TEST_PROJECT: LabDemo.MinimalApi.Tests

    steps:

    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    # TODO: only for debug
    - name: Setup .NET Core SDK ${{ matrix.dotnet-version }}
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ matrix.dotnet-version }}

    - name: Inputs
      run: |
        echo "TEST_PROJECT = $TEST_PROJECT"
        echo "Running in..."
        pwd
        cd ..
        echo "Solution tree"
        ls
        echo "Total storage consumption before job:" 
        du -sh ./* | sort -h

    - name: Run the black box tests
      run: |
        pwd
        cd ../$TEST_PROJECT
        pwd
        cd $TEST_PROJECT
        dotnet test

    - name: Metrics
      run: |
        echo "Total storage consumption after job:" 
        du -sh ..
